调优20190806---走错索引.sql


产险2016版车险外网出单系统（10.190.21.131）SQL语句6yqy8mh2z3sv3、cvr169b812s7b执行次数翻倍，至逻辑读超过基线一倍，SQL语句优化分析如下： 




01.SQL_ID：6yqy8mh2z3sv3   

优化前：其执行时间为 00:00:02.49s，逻辑读为 414K； 

优化后：其执行时间为 00:00:00.01s，逻辑读为  4 ； 





02.SQL_ID：cvr169b812s7b  

优化前：其执行时间为 00:00:02.37s，逻辑读为 414K； 

优化后：其执行时间为 00:00:00.01s，逻辑读为  4 ； 









优化建议：过滤字段PLATE_NO选择性较好，建议执行计划走 IDX_ECAR_POLICY_PLATENO 索引，建议测试后实施； 




01.SQL_ID：6yqy8mh2z3sv3  


SQL_ID        PLAN_HASH_VALUE Date time              No.execs         LIO/exec CPUTIM/exec  ETIME/exec       PIO/exec     ROWs/exec
------------- --------------- -------------------- ---------- ---------------- ----------- ----------- -------------- -------------


6yqy8mh2z3sv3       862834622 08/01/19_0000_0100          240       1304936.53        2.61        2.62            .00           .00
6yqy8mh2z3sv3       862834622 08/01/19_0100_0200          240       1299954.50        2.61        2.61            .00           .00
6yqy8mh2z3sv3       862834622 08/01/19_0200_0300          240       1299954.50        2.64        2.64            .00           .00
6yqy8mh2z3sv3       862834622 08/01/19_0300_0400          240       1299954.50        2.65        2.65            .00           .00
6yqy8mh2z3sv3       862834622 08/01/19_0400_0500          242       1290922.30        2.60        2.61            .00           .00
6yqy8mh2z3sv3       862834622 08/01/19_0500_0600          240              .00        2.63        2.63            .00           .00
6yqy8mh2z3sv3       862834622 08/01/19_0600_0700          240       1306375.35        2.64        2.64            .00           .00
6yqy8mh2z3sv3       862834622 08/01/19_0700_0800          241       1298954.45        2.63        2.63            .00           .00
6yqy8mh2z3sv3       862834622 08/01/19_0800_0900          240       1299958.79        2.66        2.66            .00           .00
6yqy8mh2z3sv3       862834622 08/01/19_0900_1000          240       1300003.21        2.76        2.76            .00           .00
6yqy8mh2z3sv3       862834622 08/01/19_1000_1101          240       1300072.53        2.75        2.76            .00           .00
6yqy8mh2z3sv3       862834622 08/01/19_1101_1200          236       1300134.00        2.75        2.75            .00           .00 

6yqy8mh2z3sv3       862834622 07/31/19_1000_1100          240       1299622.14        2.79        2.80            .00           .00
6yqy8mh2z3sv3       862834622 07/31/19_1100_1200          240       1299673.33        2.76        2.77            .00           .00
6yqy8mh2z3sv3       862834622 07/31/19_1200_1300          240       1299703.50        2.69        2.69            .00           .00
6yqy8mh2z3sv3       862834622 07/31/19_1300_1400          240       1299738.99        2.70        2.71            .00           .00
6yqy8mh2z3sv3       862834622 07/31/19_1400_1500          240       1299791.25        2.75        2.76            .00           .00
6yqy8mh2z3sv3       862834622 07/31/19_1500_1600          240       1299857.27        2.77        2.77            .00           .00
6yqy8mh2z3sv3       862834622 07/31/19_1600_1700          240              .00        2.75        2.76            .00           .00
6yqy8mh2z3sv3       862834622 07/31/19_1700_1800          240       1299922.19        2.72        2.73            .00           .00
6yqy8mh2z3sv3       862834622 07/31/19_1800_1900          240       1299951.59        2.66        2.67            .00           .00
6yqy8mh2z3sv3       862834622 07/31/19_1900_2000          240       1299952.60        2.63        2.64            .00           .00
6yqy8mh2z3sv3       862834622 07/31/19_2000_2100          240       1299954.50        2.61        2.61            .00           .00
6yqy8mh2z3sv3       862834622 07/31/19_2100_2200          240       1299954.53        2.62        2.62            .00           .00
6yqy8mh2z3sv3       862834622 07/31/19_2200_2300          241       1294560.50        2.58        2.58            .00           .00
6yqy8mh2z3sv3       862834622 07/31/19_2300_0000          240       1304079.94        2.60        2.60            .00           .00
...... 

6yqy8mh2z3sv3       862834622 08/04/19_2100_2200          120       2191666.83        4.48        4.49            .00           .00
6yqy8mh2z3sv3       862834622 08/04/19_2200_2300          120       2187568.05        4.45        4.46            .00           .00
6yqy8mh2z3sv3       862834622 08/04/19_2300_0000          120       2187568.13        4.43        4.44            .00           .00
6yqy8mh2z3sv3       862834622 08/05/19_0000_0100          120       2187568.00        4.47        4.48            .00           .00
6yqy8mh2z3sv3       862834622 08/05/19_0100_0200          120       2187568.00        4.45        4.45            .00           .00
6yqy8mh2z3sv3       862834622 08/05/19_0200_0300          120       2187568.00        4.50        4.50            .00           .00
6yqy8mh2z3sv3       862834622 08/05/19_0300_0400          120       2187568.00        4.43        4.43            .00           .00
6yqy8mh2z3sv3       862834622 08/05/19_0400_0500          120       2187568.00        4.43        4.44            .00           .00
6yqy8mh2z3sv3       862834622 08/05/19_0500_0600          120       2187568.00        4.45        4.46            .00           .00
6yqy8mh2z3sv3       862834622 08/05/19_0600_0700          120              .00        4.41        4.41            .00           .00
6yqy8mh2z3sv3       862834622 08/05/19_0700_0800          120       2187568.17        4.37        4.38            .00           .00
6yqy8mh2z3sv3       862834622 08/05/19_0800_0900          120       2187583.36        4.54        4.55            .00           .00
6yqy8mh2z3sv3       862834622 08/05/19_0900_1000          200       1478460.75        3.21        3.23            .02           .00
6yqy8mh2z3sv3       862834622 08/05/19_1000_1100          240       1301260.46        2.86        2.87            .00           .00
6yqy8mh2z3sv3       862834622 08/05/19_1100_1200          291       1145970.81        2.47        2.48            .00           .00
6yqy8mh2z3sv3       862834622 08/05/19_1200_1300          385        967517.24        2.03        2.04            .00           .00
6yqy8mh2z3sv3       862834622 08/05/19_1300_1400          421        919340.62        1.95        1.95            .00           .00
6yqy8mh2z3sv3       862834622 08/05/19_1400_1500          420        923304.03        2.00        2.00            .00           .00


SQL_ID 6yqy8mh2z3sv3
--------------------
select *
  from (select decode(p.id, null, q.id, p.id) as id,
               q.quotation_no,
               q.status,
               q.in_status,
               q.quotation_time as update_time,
               q.plate_no,
               q.purchase_price,
               q.engine_no,
               q.model_type,
               q.car_vin,
               p.insured_no,
               p.policy_no,
               p.tax_Amount,
               p.print_sign,
               p.product_code as usage_type,
               p.policy_type,
               p.premium_amount as total_premium,
               p.begin_date,
               p.end_date,
               p.insured_name as party_name,
               p.acdt_Amount as acdt_premium_Amount,
               '1' as if_Local,
               p.business_Id as biz_unique_id,
               q.read_only,
               q.is_saic,
               q.is_eapplication,
               q.istwocar as is_two_car,
               p.create_epolicy
          from ecar_quotation q
          left join ecar_policy p
            on q.id = p.quotation_id
           and p.branch_code = :1
           and q.branch_code = p.branch_code
         where 1 = 1
           and q.branch_code = :2
           and q.partner_id = :3
           and p.plate_no = :4
         order by q.quotation_time desc, p.id desc)
 where rownum <= :5


Plan hash value: 862834622

----------------------------------------------------------------------------------------------------------------------------
| Id  | Operation                                | Name                   | E-Rows | Cost (%CPU)|  OMem |  1Mem | Used-Mem |
----------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT                         |                        |        |     9 (100)|       |       |          |
|*  1 |  COUNT STOPKEY                           |                        |        |            |       |       |          |
|   2 |   VIEW                                   |                        |      1 |     9  (12)|       |       |          |
|*  3 |    SORT ORDER BY STOPKEY                 |                        |      1 |     9  (12)|  1024 |  1024 |          |
|*  4 |     FILTER                               |                        |        |            |       |       |          |
|   5 |      NESTED LOOPS                        |                        |      1 |     8   (0)|       |       |          |
|   6 |       NESTED LOOPS                       |                        |      2 |     8   (0)|       |       |          |
|   7 |        PARTITION LIST SINGLE             |                        |      1 |     4   (0)|       |       |          |
|   8 |         TABLE ACCESS BY LOCAL INDEX ROWID| ECAR_QUOTATION         |      1 |     4   (0)|       |       |          |
|*  9 |          INDEX RANGE SCAN                | QUOTATION_BPP_INDEX    |      1 |     3   (0)|       |       |          |
|  10 |        PARTITION LIST SINGLE             |                        |      2 |     2   (0)|       |       |          |
|* 11 |         INDEX RANGE SCAN                 | IDX_ECAR_POLICY_QID_01 |      2 |     2   (0)|       |       |          |
|* 12 |       TABLE ACCESS BY LOCAL INDEX ROWID  | ECAR_POLICY            |      1 |     4   (0)|       |       |          |
----------------------------------------------------------------------------------------------------------------------------

Predicate Information (identified by operation id):
---------------------------------------------------

   1 - filter(ROWNUM<=:5)
   3 - filter(ROWNUM<=:5)
   4 - filter(:2=:1)
   9 - access("Q"."BRANCH_CODE"=:1 AND "Q"."PARTNER_ID"=:3)
       filter("Q"."BRANCH_CODE"=:2)
  11 - access("Q"."ID"="P"."QUOTATION_ID")
  12 - filter(("P"."PLATE_NO"=:4 AND "P"."BRANCH_CODE"=:1 AND "P"."BRANCH_CODE"=:2))




--优化前：
Plan hash value: 862834622

---------------------------------------------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation                                | Name                   | Starts | E-Rows | Cost (%CPU)| A-Rows |   A-Time   | Buffers |  OMem |  1Mem | Used-Mem |
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT                         |                        |      1 |        |     9 (100)|      0 |00:00:02.49 |     414K|   |       |          |
|*  1 |  COUNT STOPKEY                           |                        |      1 |        |            |      0 |00:00:02.49 |     414K|   |       |          |
|   2 |   VIEW                                   |                        |      1 |      1 |     9  (12)|      0 |00:00:02.49 |     414K|   |       |          |
|*  3 |    SORT ORDER BY STOPKEY                 |                        |      1 |      1 |     9  (12)|      0 |00:00:02.49 |     414K|  1024 |  1024 |      |
|*  4 |     FILTER                               |                        |      1 |        |            |      0 |00:00:02.49 |     414K|   |       |          |
|   5 |      NESTED LOOPS                        |                        |      1 |      1 |     8   (0)|      0 |00:00:02.49 |     414K|   |       |          |
|   6 |       NESTED LOOPS                       |                        |      1 |      2 |     8   (0)|    140K|00:00:01.90 |     335K|   |       |          |
|   7 |        PARTITION LIST SINGLE             |                        |      1 |      1 |     4   (0)|    117K|00:00:00.55 |     104K|   |       |          |
|   8 |         TABLE ACCESS BY LOCAL INDEX ROWID| ECAR_QUOTATION         |      1 |      1 |     4   (0)|    117K|00:00:00.43 |     104K|   |       |          |
|*  9 |          INDEX RANGE SCAN                | QUOTATION_BPP_INDEX    |      1 |      1 |     3   (0)|    117K|00:00:00.08 |     722 |   |       |          |
|  10 |        PARTITION LIST SINGLE             |                        |    117K|      2 |     2   (0)|    140K|00:00:01.04 |     231K|   |       |          |
|* 11 |         INDEX RANGE SCAN                 | IDX_ECAR_POLICY_QID_01 |    117K|      2 |     2   (0)|    140K|00:00:00.56 |     231K|   |       |          |
|* 12 |       TABLE ACCESS BY LOCAL INDEX ROWID  | ECAR_POLICY            |    140K|      1 |     4   (0)|      0 |00:00:00.36 |   79392 |   |       |          |
---------------------------------------------------------------------------------------------------------------------------------------------------------------------

Predicate Information (identified by operation id):
---------------------------------------------------

   1 - filter(ROWNUM<=:V5)
   3 - filter(ROWNUM<=:V5)
   4 - filter(:V2=:V1)
   9 - access("Q"."BRANCH_CODE"=:V1 AND "Q"."PARTNER_ID"=:V3)
       filter("Q"."BRANCH_CODE"=:V2)
  11 - access("Q"."ID"="P"."QUOTATION_ID")
  12 - filter(("P"."PLATE_NO"=:V4 AND "P"."BRANCH_CODE"=:V1 AND "P"."BRANCH_CODE"=:V2))


--优化后：


Plan hash value: 1823559026

----------------------------------------------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation                                | Name                    | Starts | E-Rows | Cost (%CPU)| A-Rows |   A-Time   | Buffers |  OMem |  1Mem | Used-Mem |
----------------------------------------------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT                         |                         |      1 |        |    10 (100)|      0 |00:00:00.01 |  4 |        |       |          |
|*  1 |  COUNT STOPKEY                           |                         |      1 |        |            |      0 |00:00:00.01 |  4 |        |       |          |
|   2 |   VIEW                                   |                         |      1 |      1 |    10  (10)|      0 |00:00:00.01 |  4 |        |       |          |
|*  3 |    SORT ORDER BY STOPKEY                 |                         |      1 |      1 |    10  (10)|      0 |00:00:00.01 |  4 |    1024  |  1024 |           |
|*  4 |     FILTER                               |                         |      1 |        |            |      0 |00:00:00.01 |  4 |        |       |          |
|   5 |      NESTED LOOPS                        |                         |      1 |      1 |     9   (0)|      0 |00:00:00.01 |  4 |        |       |          |
|   6 |       NESTED LOOPS                       |                         |      1 |      1 |     9   (0)|      0 |00:00:00.01 |  4 |        |       |          |
|*  7 |        TABLE ACCESS BY GLOBAL INDEX ROWID| ECAR_POLICY             |      1 |      1 |     7   (0)|      0 |00:00:00.01 |  4 |        |       |          |
|*  8 |         INDEX RANGE SCAN                 | IDX_ECAR_POLICY_PLATENO |      1 |      4 |     4   (0)|      7 |00:00:00.01 |  4 |        |       |          |
|*  9 |        INDEX UNIQUE SCAN                 | ECAR_QUOTATION_PK1      |      0 |      1 |     1   (0)|      0 |00:00:00.01 |  0 |        |       |          |
|* 10 |       TABLE ACCESS BY GLOBAL INDEX ROWID | ECAR_QUOTATION          |      0 |      1 |     2   (0)|      0 |00:00:00.01 |  0 |        |       |          |
----------------------------------------------------------------------------------------------------------------------------------------------------------------------

Predicate Information (identified by operation id):
---------------------------------------------------

   1 - filter(ROWNUM<=:V5)
   3 - filter(ROWNUM<=:V5)
   4 - filter(:V2=:V1)
   7 - filter(("P"."BRANCH_CODE"=:V1 AND "P"."BRANCH_CODE"=:V2))
   8 - access("P"."PLATE_NO"=:V4)
   9 - access("Q"."ID"="P"."QUOTATION_ID")
  10 - filter(("Q"."PARTNER_ID"=:V3 AND "Q"."BRANCH_CODE"=:V2 AND "Q"."BRANCH_CODE"=:V1))







02.SQL_ID：cvr169b812s7b  

SQL_ID        PLAN_HASH_VALUE Date time              No.execs         LIO/exec CPUTIM/exec  ETIME/exec       PIO/exec     ROWs/exec
------------- --------------- -------------------- ---------- ---------------- ----------- ----------- -------------- ------------- 



cvr169b812s7b      1740164280 07/31/19_0900_1000          239       1295855.54        2.59        2.60            .00         71.93
cvr169b812s7b      1740164280 07/31/19_1000_1100          240       1299621.80        2.62        2.63            .00         72.63
cvr169b812s7b      1740164280 07/31/19_1100_1200          240       1299673.07        2.60        2.61            .00         73.63
cvr169b812s7b      1740164280 07/31/19_1200_1300          240       1299703.03        2.54        2.54            .00         74.63
cvr169b812s7b      1740164280 07/31/19_1300_1400          240       1299738.46        2.55        2.55            .00         75.63
cvr169b812s7b      1740164280 07/31/19_1400_1500          240       1299791.47        2.59        2.60            .00         76.63
cvr169b812s7b      1740164280 07/31/19_1500_1600          240              .00        2.60        2.61            .00         77.63
cvr169b812s7b      1740164280 07/31/19_1600_1700          240       1299893.10        2.59        2.60            .00         78.63
cvr169b812s7b      1740164280 07/31/19_1700_1800          240       1299921.83        2.57        2.57            .00         79.63
cvr169b812s7b      1740164280 07/31/19_1800_1900          240       1299951.62        2.51        2.51            .00         80.63
cvr169b812s7b      1740164280 07/31/19_1900_2000          240       1299952.65        2.48        2.48            .00         81.63
cvr169b812s7b      1740164280 07/31/19_2000_2100          241       1297832.92        2.45        2.46            .00         82.29
cvr169b812s7b      1740164280 07/31/19_2100_2200          240       1299761.89        2.47        2.47            .00         83.63
cvr169b812s7b      1740164280 07/31/19_2200_2300          240       1305968.55        2.45        2.46            .00         84.64
cvr169b812s7b      1740164280 07/31/19_2300_0000          240       1299954.50        2.45        2.45            .00         85.64
cvr169b812s7b      1740164280 08/01/19_0000_0100          240       1299954.50        2.46        2.46            .00         86.64
cvr169b812s7b      1740164280 08/01/19_0100_0200          240       1299954.50        2.47        2.47            .00         87.64
cvr169b812s7b      1740164280 08/01/19_0200_0300          241       1294560.50        2.48        2.49            .00         88.27
cvr169b812s7b      1740164280 08/01/19_0300_0400          241       1298127.66        2.51        2.51            .00         89.27
cvr169b812s7b      1740164280 08/01/19_0400_0500          240       1307205.43        2.48        2.49            .00         90.65
cvr169b812s7b      1740164280 08/01/19_0500_0600          240              .00        2.48        2.49            .00         91.65
cvr169b812s7b      1740164280 08/01/19_0600_0700          241       1294560.50        2.47        2.48            .00         92.26
cvr169b812s7b      1740164280 08/01/19_0700_0800          240       1301680.10        2.49        2.49            .00         93.65
cvr169b812s7b      1740164280 08/01/19_0800_0900          240       1299958.51        2.51        2.51            .00         94.65
cvr169b812s7b      1740164280 08/01/19_0900_1000          240       1300003.30        2.61        2.61            .00         95.65
cvr169b812s7b      1740164280 08/01/19_1000_1101          240       1300072.72        2.59        2.60            .00         96.65
cvr169b812s7b      1740164280 08/01/19_1101_1200          236       1300133.80        2.59        2.60            .00         99.29



cvr169b812s7b      1740164280 08/03/19_1800_1900          120       2187487.23        4.17        4.18            .00        268.47
cvr169b812s7b      1740164280 08/03/19_1900_2000          120       2187492.08        4.15        4.15            .00        269.47
cvr169b812s7b      1740164280 08/03/19_2000_2100          120       2187492.07        4.22        4.23            .00        270.47
cvr169b812s7b      1740164280 08/03/19_2100_2200          121              .00        4.13        4.13            .00        269.22
cvr169b812s7b      1740164280 08/03/19_2200_2300          120       2194097.51        4.17        4.17            .00        272.47
cvr169b812s7b      1740164280 08/03/19_2300_0000          120       2196715.65        4.17        4.17            .00        273.47
cvr169b812s7b      1740164280 08/04/19_0000_0100          120       2189891.96        4.20        4.21            .01        274.48
cvr169b812s7b      1740164280 08/04/19_0100_0200          120       2187492.00        4.17        4.18            .00        275.48
cvr169b812s7b      1740164280 08/04/19_0200_0300          120       2187492.00        4.17        4.18            .00        276.48
cvr169b812s7b      1740164280 08/04/19_0300_0400          120       2187492.00        4.15        4.16            .00        277.48
cvr169b812s7b      1740164280 08/04/19_0400_0500          120       2187492.00        4.20        4.21            .00        278.48
cvr169b812s7b      1740164280 08/04/19_0500_0600          120       2187492.00        4.15        4.16            .00        279.48
cvr169b812s7b      1740164280 08/04/19_0600_0700          120       2187492.00        4.20        4.21            .00        280.48
cvr169b812s7b      1740164280 08/04/19_0700_0800          120       2187492.00        4.18        4.19            .00        281.48
cvr169b812s7b      1740164280 08/04/19_0800_0900          120       2187492.47        4.19        4.20            .00        282.48
cvr169b812s7b      1740164280 08/04/19_0900_1000          120       2187501.01        4.28        4.29            .00        283.48
cvr169b812s7b      1740164280 08/04/19_1000_1100          120       2187524.01        4.26        4.27            .00        284.48
cvr169b812s7b      1740164280 08/04/19_1100_1201          120       2187543.58        4.24        4.25            .00        285.48
cvr169b812s7b      1740164280 08/04/19_1201_1300          118       2187544.33        4.19        4.19            .00        291.31
cvr169b812s7b      1740164280 08/04/19_1300_1400          120       2187550.83        4.19        4.20            .01        287.46
cvr169b812s7b      1740164280 08/04/19_1400_1500          120       2187550.18        4.25        4.26            .00        288.46
cvr169b812s7b      1740164280 08/04/19_1500_1600          121              .00        4.19        4.20            .00        287.07
cvr169b812s7b      1740164280 08/04/19_1600_1700          120       2194510.76        4.23        4.24            .06        290.46
cvr169b812s7b      1740164280 08/04/19_1700_1800          120       2198855.89        4.25        4.26            .01        291.47
cvr169b812s7b      1740164280 08/04/19_1800_1900          120       2187568.02        4.16        4.17            .00        292.47
cvr169b812s7b      1740164280 08/04/19_1900_2000          120       2187568.05        4.14        4.15            .00        293.47
cvr169b812s7b      1740164280 08/04/19_2000_2100          120       2187568.11        4.15        4.16            .00        294.47



... ...
cvr169b812s7b      1740164280 08/04/19_2100_2200          120       2187568.08        4.20        4.20            .00        295.47
cvr169b812s7b      1740164280 08/04/19_2200_2300          120       2187568.09        4.17        4.18            .00        296.47
cvr169b812s7b      1740164280 08/04/19_2300_0000          120       2187568.03        4.15        4.16            .00        297.47
cvr169b812s7b      1740164280 08/05/19_0000_0100          120       2187568.00        4.19        4.20            .00        298.47
cvr169b812s7b      1740164280 08/05/19_0100_0200          120       2187568.00        4.19        4.19            .00        299.47
cvr169b812s7b      1740164280 08/05/19_0200_0300          120       2187568.00        4.22        4.23            .00        300.47
cvr169b812s7b      1740164280 08/05/19_0300_0400          120       2187568.00        4.15        4.16            .00        301.47
cvr169b812s7b      1740164280 08/05/19_0400_0500          120       2187568.00        4.16        4.17            .00        302.47
cvr169b812s7b      1740164280 08/05/19_0500_0600          120       2187568.00        4.19        4.20            .00        303.47
cvr169b812s7b      1740164280 08/05/19_0600_0700          120       2187568.00        4.14        4.14            .00        304.47
cvr169b812s7b      1740164280 08/05/19_0700_0800          120              .00        4.12        4.12            .00        305.47
cvr169b812s7b      1740164280 08/05/19_0800_0900          120       2187583.84        4.28        4.29            .00        306.47
cvr169b812s7b      1740164280 08/05/19_0900_1000          200       1478452.15        3.03        3.24         110.39        184.88
cvr169b812s7b      1740164280 08/05/19_1000_1100          241       1295860.77        2.68        2.69            .00        154.42
cvr169b812s7b      1740164280 08/05/19_1100_1200          291       1148684.62        2.33        2.34            .00        128.89
cvr169b812s7b      1740164280 08/05/19_1200_1300          385        969621.94        1.92        1.92            .00         98.42
cvr169b812s7b      1740164280 08/05/19_1300_1400          420        922929.24        1.83        1.84            .00         91.22
cvr169b812s7b      1740164280 08/05/19_1400_1500          421        919378.33        1.85        1.86            .00         92.00





SQL_ID cvr169b812s7b
--------------------
select count(*)
  from (select decode(p.id, null, q.id, p.id) as id,
               q.quotation_no,
               q.status,
               q.in_status,
               q.quotation_time as update_time,
               q.plate_no,
               q.purchase_price,
               q.engine_no,
               q.model_type,
               q.car_vin,
               p.insured_no,
               p.policy_no,
               p.tax_Amount,
               p.print_sign,
               p.product_code as usage_type,
               p.policy_type,
               p.premium_amount as total_premium,
               p.begin_date,
               p.end_date,
               p.insured_name as party_name,
               p.acdt_Amount as acdt_premium_Amount,
               '1' as if_Local,
               p.business_Id as biz_unique_id,
               q.read_only,
               q.is_saic,
               q.is_eapplication,
               q.istwocar as is_two_car,
               p.create_epolicy
          from ecar_quotation q
          left join ecar_policy p
            on q.id = p.quotation_id
           and p.branch_code = :1
           and q.branch_code = p.branch_code
         where 1 = 1
           and q.branch_code = :2
           and q.partner_id = :3
           and p.plate_no = :4
         order by q.quotation_time desc, p.id desc)


Plan hash value: 1740164280

-----------------------------------------------------------------------------------------------
| Id  | Operation                              | Name                   | E-Rows | Cost (%CPU)|
-----------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT                       |                        |        |     8 (100)|
|   1 |  SORT AGGREGATE                        |                        |      1 |            |
|*  2 |   FILTER                               |                        |        |            |
|   3 |    NESTED LOOPS                        |                        |      1 |     8   (0)|
|   4 |     NESTED LOOPS                       |                        |      2 |     8   (0)|
|   5 |      PARTITION LIST SINGLE             |                        |      1 |     4   (0)|
|   6 |       TABLE ACCESS BY LOCAL INDEX ROWID| ECAR_QUOTATION         |      1 |     4   (0)|
|*  7 |        INDEX RANGE SCAN                | QUOTATION_BPP_INDEX    |      1 |     3   (0)|
|   8 |      PARTITION LIST SINGLE             |                        |      2 |     2   (0)|
|*  9 |       INDEX RANGE SCAN                 | IDX_ECAR_POLICY_QID_01 |      2 |     2   (0)|
|* 10 |     TABLE ACCESS BY LOCAL INDEX ROWID  | ECAR_POLICY            |      1 |     4   (0)|
-----------------------------------------------------------------------------------------------

Predicate Information (identified by operation id):
---------------------------------------------------

   2 - filter(:2=:1)
   7 - access("Q"."BRANCH_CODE"=:1 AND "Q"."PARTNER_ID"=:3)
       filter("Q"."BRANCH_CODE"=:2)
   9 - access("Q"."ID"="P"."QUOTATION_ID")
  10 - filter(("P"."PLATE_NO"=:4 AND "P"."BRANCH_CODE"=:1 AND "P"."BRANCH_CODE"=:2))




--优化前： 

Plan hash value: 1740164280

----------------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation                              | Name                   | Starts | E-Rows | Cost (%CPU)| A-Rows |   A-Time   | Buffers |
----------------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT                       |                        |      1 |        |     8 (100)|      1 |00:00:02.37 |     414K|
|   1 |  SORT AGGREGATE                        |                        |      1 |      1 |            |      1 |00:00:02.37 |     414K|
|*  2 |   FILTER                               |                        |      1 |        |            |      0 |00:00:02.37 |     414K|
|   3 |    NESTED LOOPS                        |                        |      1 |      1 |     8   (0)|      0 |00:00:02.37 |     414K|
|   4 |     NESTED LOOPS                       |                        |      1 |      2 |     8   (0)|    140K|00:00:01.80 |     335K|
|   5 |      PARTITION LIST SINGLE             |                        |      1 |      1 |     4   (0)|    117K|00:00:00.49 |     104K|
|   6 |       TABLE ACCESS BY LOCAL INDEX ROWID| ECAR_QUOTATION         |      1 |      1 |     4   (0)|    117K|00:00:00.37 |     104K|
|*  7 |        INDEX RANGE SCAN                | QUOTATION_BPP_INDEX    |      1 |      1 |     3   (0)|    117K|00:00:00.08 |     722 |
|   8 |      PARTITION LIST SINGLE             |                        |    117K|      2 |     2   (0)|    140K|00:00:01.01 |     231K|
|*  9 |       INDEX RANGE SCAN                 | IDX_ECAR_POLICY_QID_01 |    117K|      2 |     2   (0)|    140K|00:00:00.55 |     231K|
|* 10 |     TABLE ACCESS BY LOCAL INDEX ROWID  | ECAR_POLICY            |    140K|      1 |     4   (0)|      0 |00:00:00.35 |   79392 |
----------------------------------------------------------------------------------------------------------------------------------------

Predicate Information (identified by operation id):
---------------------------------------------------

   2 - filter(:V2=:V1)
   7 - access("Q"."BRANCH_CODE"=:V1 AND "Q"."PARTNER_ID"=:V3)
       filter("Q"."BRANCH_CODE"=:V2)
   9 - access("Q"."ID"="P"."QUOTATION_ID")
  10 - filter(("P"."PLATE_NO"=:V4 AND "P"."BRANCH_CODE"=:V1 AND "P"."BRANCH_CODE"=:V2)) 




--优化后： 




Plan hash value: 3066749303

-----------------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation                              | Name                    | Starts | E-Rows | Cost (%CPU)| A-Rows |   A-Time   | Buffers |
-----------------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT                       |                         |      1 |        |     9 (100)|      1 |00:00:00.01 |       4 |
|   1 |  SORT AGGREGATE                        |                         |      1 |      1 |            |      1 |00:00:00.01 |       4 |
|*  2 |   FILTER                               |                         |      1 |        |            |      0 |00:00:00.01 |       4 |
|   3 |    NESTED LOOPS                        |                         |      1 |      1 |     9   (0)|      0 |00:00:00.01 |       4 |
|   4 |     NESTED LOOPS                       |                         |      1 |      1 |     9   (0)|      0 |00:00:00.01 |       4 |
|*  5 |      TABLE ACCESS BY GLOBAL INDEX ROWID| ECAR_POLICY             |      1 |      1 |     7   (0)|      0 |00:00:00.01 |       4 |
|*  6 |       INDEX RANGE SCAN                 | IDX_ECAR_POLICY_PLATENO |      1 |      4 |     4   (0)|      7 |00:00:00.01 |       4 |
|*  7 |      INDEX UNIQUE SCAN                 | ECAR_QUOTATION_PK1      |      0 |      1 |     1   (0)|      0 |00:00:00.01 |       0 |
|*  8 |     TABLE ACCESS BY GLOBAL INDEX ROWID | ECAR_QUOTATION          |      0 |      1 |     2   (0)|      0 |00:00:00.01 |       0 |
-----------------------------------------------------------------------------------------------------------------------------------------

Predicate Information (identified by operation id):
---------------------------------------------------

   2 - filter(:V2=:V1)
   5 - filter(("P"."BRANCH_CODE"=:V1 AND "P"."BRANCH_CODE"=:V2))
   6 - access("P"."PLATE_NO"=:V4)
   7 - access("Q"."ID"="P"."QUOTATION_ID")
   8 - filter(("Q"."PARTNER_ID"=:V3 AND "Q"."BRANCH_CODE"=:V2 AND "Q"."BRANCH_CODE"=:V1))

